
<div class="global-actions-btn">
  <button matFab extended (click)="openAddAssetDialog()" class="add-asset">
    <mat-icon>add</mat-icon>
    Ajouter un actif
  </button>
</div>

<table mat-table matSort
       [dataSource]="assetsDatasource()" multiTemplateDataRows
       (matSortChange)="walletSort.set($event)"
       class="mat-elevation-z8">

  <ng-container matColumnDef="symbol">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Symbole</th>
    <td mat-cell *matCellDef="let asset" style="padding-left: 10px;">{{asset.symbol ?? '-'}}</td>
  </ng-container>

  <ng-container matColumnDef="name">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Dénomination</th>
    <td mat-cell *matCellDef="let asset">{{asset.name}}</td>
  </ng-container>

  <ng-container matColumnDef="totalParts">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Nbr parts</th>
    <td mat-cell *matCellDef="let asset" style="padding-left: 30px;">{{asset.totalParts}}</td>
  </ng-container>

  <ng-container matColumnDef="totalValue">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Total</th>
    <td mat-cell *matCellDef="let asset">{{asset.totalValue | currency: 'EUR'}}</td>
  </ng-container>

  <ng-container matColumnDef="type">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
    <td mat-cell *matCellDef="let asset">
      <span [class]="'asset-badge' + ' ' + 'asset-badge-' + asset.type.toLowerCase()">
        {{asset.type}}
      </span>
    </td>
  </ng-container>

  <ng-container matColumnDef="action">
    <th mat-header-cell *matHeaderCellDef>&nbsp;</th>
    <td mat-cell *matCellDef="let asset" class="asset-actions">
      <button
        mat-button
        aria-label="expand row"
        (click)="openAddTransactionDialog(asset.object, TransactionType.BUY);$event.stopPropagation()">
        Achat
      </button>
      <button
        mat-button
        aria-label="expand row"
        (click)="openAddTransactionDialog(asset.object, TransactionType.SELL);$event.stopPropagation()">
        Vente
      </button>

      <button matIconButton [matMenuTriggerFor]="menu" aria-label="Example icon-button with a menu"
              (click)="$event.stopPropagation();">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #menu="matMenu">
        <button mat-menu-item>
          <mat-icon>edit</mat-icon>
          <span>Editer</span>
        </button>
        <button mat-menu-item (click)="deleteAsset(asset.object); ">
          <mat-icon>delete</mat-icon>
          <span>Supprimer</span>
        </button>
      </mat-menu>
    </td>
  </ng-container>

  <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
  <ng-container matColumnDef="expandedDetail">
    <td mat-cell *matCellDef="let asset" [attr.colspan]="columnsToDisplayWithExpand.length">

      <div class="asset-detail-wrapper"
           [class.asset-detail-wrapper-expanded]="isExpanded(asset.object)">
          <!-- [@detailExpand]="asset.object == expandedAsset ? 'expanded' : 'collapsed'"-->

        <div class="asset-detail-inner">

          <div class="instrument-chart">
            @if (isExpanded(asset.object)) {
              <app-asset-chart
                [asset]="asset.object"
                [label]="asset.name"
                [color]="getAssetColor(asset.type)">
              </app-asset-chart>
            }
          </div>

          <div class="transactions-panel">
            <h3>Historique récent</h3>
            <div class="timeline">
              @for (transaction of getTransactions(asset.name); track transaction.id) {
                <div class="timeline-item">
                  <div class="timeline-marker" [class.marker-buy]="transaction.type === 'BUY'" [class.marker-sell]="transaction.type === 'SELL'"></div>
                  <div class="timeline-content">
                    <div class="t-date">{{transaction.date | date: 'dd MMM yyyy'}}</div>
                    <div class="t-details">
                    <span [class.text-buy]="transaction.type === 'BUY'" [class.text-sell]="transaction.type === 'SELL'">
                      {{transaction.type === 'BUY' ? 'Achat' : 'Vente'}}
                    </span>
                      de <strong>{{transaction.quantity}}</strong> parts à {{transaction.price | number:'1.2-2'}} {{transaction.currency}}
                    </div>
                  </div>
                </div>
              }
              @if (getTransactions(asset.name)?.length === 0) {
                <div class="no-data">Aucune transaction</div>
              }
            </div>
          </div>

        </div>
      </div>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
  <tr mat-row *matRowDef="let asset; columns: columnsToDisplayWithExpand;"
      [class.asset-expanded-row]="isExpanded(asset)"
      class="cursor-pointer asset-row"
      (click)="toggle(asset.object)">
  </tr>
  <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="asset-detail-row"></tr>
</table>
